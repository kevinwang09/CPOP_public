---
title: "Building final models using the MIA features, Survival"
author: "Kevin Wang"
date: "`r paste0('Initiated on 2020 Mar 28, compiled on ', format(Sys.time(), '%Y %b %d'))`"
output:
  html_document:
    code_folding: hide
    fig_height: 10
    fig_width: 10
    toc: yes
    number_sections: true
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
---


# Summary

We present two ways of presenting the final model

+ Using the bootstrapped MIA CPOP models as an ensemble of models to make predictions 
+ Using the bootstrapped MIA CPOP models' features as a final features to come up with one singular model for prediction 



```{r}
today = format(Sys.time(), "%Y_%b_%d")
cat("This file was compiled on", today)


suppressPackageStartupMessages({
  library(tidyverse)
  library(CPOP)
  library(glmnet)
  library(yardstick)
  library(survival)
  library(survminer)
  library(ggsci)
  library(ggbeeswarm)
  library(patchwork)
  
})

theme_set(theme_classic(12) +
            theme(legend.position = "bottom"))
```


## data

```{r}
file_version = "2020_Apr_25"
load(paste0(
  "../data/processed_data/Melanoma4_binary_",
  file_version, ".RData"
))


load(paste0(
  "../data/processed_data/Melanoma4_survival_",
  file_version, ".RData"
))

## Bootstrapped MIA features 
load("../data/processed_data/boot_MIA_cpop_2021_Nov_02.RData")
```


```{r}
list_lratio_binary = list_raw_data_binary %>%
  purrr::map(t) %>%
  purrr::map(CPOP::pairwise_col_diff)

list_lratio_survival = list_raw_data %>%
  purrr::map(t) %>%
  purrr::map(CPOP::pairwise_col_diff)
```




## Customised functions
```{r}
join_tcga_sample_data = function(dat, by){
  dat %>% 
    left_join(tcga_sample_data, by = c("samples" = "sample_id")) %>% 
    dplyr::filter(naive_tumor_stage == "stageIII", !str_detect(samples, "TCGA-EE")) %>% 
    dplyr::mutate(
      time = time/365
    )
}

join_sweden_sample_data = function(dat, by){
  dat %>% 
    left_join(sweden_sample_data, by = c("samples" = "sample_id")) %>% 
    # dplyr::filter(tissue_type %in% c("Subcutaneous", "Visceral")) %>%
    dplyr::mutate(time = dss/365, status = dss_dead)
}

binary_split = function(prob){
  ifelse(prob > 0.5, "Poor", "Good")
}

trinary_split = function(prob){
  case_when(
    prob < 0.3 ~ "Good",
    prob < 0.7 ~ "Moderate",
    prob < 1 ~ "Poor"
  )
}
```


# Survival times distributional comparison 


```{r}
list_surv_times = lst(
  mia = tibble(
    time = rfs_array_sample_data_reduced$RFS, 
    dead = rfs_array_sample_data_reduced$dead), 
  tcga = tibble(
    time = tcga_sample_data$time/365, 
    dead = tcga_sample_data$status),
  sweden = tibble(
    time = sweden_sample_data$dss/365, 
    dead = sweden_sample_data$dss_dead))

surv_times_tbl = list_surv_times %>% bind_rows(.id = "data_source")

list_survival_lassoy = list(
  ns = Surv(rfs_ns_sample_data_reduced$RFS + 1,
            rfs_ns_sample_data_reduced$dead),
  array = Surv(rfs_array_sample_data_reduced$RFS + 1,
               rfs_array_sample_data_reduced$dead),
  tcga = Surv(tcga_sample_data$time,
               tcga_sample_data$status),
  sweden = Surv(sweden_sample_data$dss,
               sweden_sample_data$dss_dead))
```

# Single CPOP model from MIA 
```{r}
set.seed(12)

mia_cpop_binary = CPOP::cpop_model(
  z1 = list_lratio_binary$ns,
  z2 = list_lratio_binary$array,
  y1 = list_binary_lassoy$ns,
  y2 = list_binary_lassoy$array,
  family = "binomial",
  alpha = 0.1,
  n_features = 20)

save(mia_cpop_binary, file = "../data/processed_data/shiny_models_2021_Nov_02.RData")
```


## TCGA 
```{r}
mia_single_pred_tcga = predict_cpop(mia_cpop_binary, newz = list_lratio_survival$tcga) %>% 
  join_tcga_sample_data() %>% 
  dplyr::mutate(
    pred_prob = CPOP::expit(cpop_model_avg),
    binary_class = binary_split(pred_prob)) %>% as.data.frame()

table(mia_single_pred_tcga$binary_class)

singlemia_tcga_km = survminer::ggsurvplot(
  fit = survfit(Surv(time, status) ~ binary_class, 
                data = mia_single_pred_tcga), 
  data = mia_single_pred_tcga, 
  break.time.by = 5,
  pval = TRUE, risk.table = "nrisk_cumevents")

singlemia_tcga_km2 = singlemia_tcga_km$plot +
  ggsci::scale_colour_d3()

singlemia_tcga_km3 = singlemia_tcga_km$table +
  ggsci::scale_colour_d3()

coxph(Surv(time, status) ~ pred_prob + age + gender, 
      data = mia_single_pred_tcga)

singlemia_tcga_km_plots = singlemia_tcga_km2 + singlemia_tcga_km3 +
  patchwork::plot_layout(ncol = 1, byrow = FALSE, heights = c(1.5, 1))

singlemia_tcga_km_plots

ggsave(plot = print(singlemia_tcga_km_plots),
       filename = paste0("../figures/singlemia_tcga_km_plots_", today, ".eps"),
       height = 6, width = 8)
```

## sweden 
```{r}
mia_single_pred_sweden = predict_cpop(mia_cpop_binary, newz = list_lratio_survival$sweden) %>% 
  join_sweden_sample_data() %>% 
  dplyr::mutate(
    pred_prob = CPOP::expit(cpop_model_avg),
    binary_class = binary_split(pred_prob)) %>% as.data.frame()

table(mia_single_pred_sweden$binary_class)

singlemia_sweden_km = survminer::ggsurvplot(
  fit = survfit(Surv(time, status) ~ binary_class, 
                data = mia_single_pred_sweden), 
  data = mia_single_pred_sweden, 
  break.time.by = 5,
  pval = TRUE, risk.table = "nrisk_cumevents")

singlemia_sweden_km2 = singlemia_sweden_km$plot +
  ggsci::scale_colour_d3()

singlemia_sweden_km3 = singlemia_sweden_km$table +
  ggsci::scale_colour_d3()

coxph(Surv(time, status) ~ pred_prob + age + gender, 
      data = mia_single_pred_sweden)

singlemia_sweden_km_plots = singlemia_sweden_km2 + singlemia_sweden_km3 +
  patchwork::plot_layout(ncol = 1, byrow = FALSE, heights = c(1.5, 1))

singlemia_sweden_km_plots

ggsave(plot = print(singlemia_sweden_km_plots),
       filename = paste0("../figures/singlemia_sweden_km_plots_", today, ".eps"),
       height = 6, width = 8)
```
