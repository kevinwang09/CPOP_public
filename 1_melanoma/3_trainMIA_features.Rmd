---
title: "Training features from MIA samples"
author: "Kevin Wang"
date: "`r paste0('Initiated on 2020 Feb 14, compiled on ', format(Sys.time(), '%Y %b %d'))`"
output:
  html_document:
    code_folding: hide
    fig_height: 10
    fig_width: 10
    toc: yes
    number_sections: true
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Summary

+ In this document, the CPOP feature selection is done between MIA-microarray and MIA-NS. Bootstrap is used to induce variability in the training data. We will output a RData file with all the features. 


# Loading 

## Packages

```{r}
today = format(Sys.time(), "%Y_%b_%d")
cat("This file was compiled on", today)


suppressPackageStartupMessages({
  library(tidyverse)
  library(CPOP)
  library(glmnet)
  library(yardstick)
  library(ggbeeswarm)
  library(survival)
  library(survminer)
})

theme_set(theme_classic(12) +
            theme(legend.position = "bottom"))
```


## data

```{r}
file_version = "2020_Jan_12"
load(paste0(
  "data/Melanoma4_binary_",
  file_version, ".RData"
))


load(paste0(
  "data/Melanoma4_survival_",
  file_version, ".RData"
))
```

# Construct logratio matrices
```{r}
list_raw_data_binary = list_raw_data_binary %>% purrr::map(t)

list_lratio_binary = purrr::map(list_raw_data_binary, CPOP::pairwise_col_diff)

list_lratio_data_survival = list_raw_data %>%
  purrr::map(t) %>%
  purrr::map(CPOP::pairwise_col_diff)

sapply(list_raw_data_binary, dim)
sapply(list_lratio_binary, dim)
sapply(list_lratio_data_survival, dim)
```


# Single run of CPOP to illustrate 

```{r}
ns_array_w = CPOP::compute_weights(
  list_lratio_binary$ns,
  list_lratio_binary$array)

set.seed(123)

single_cpop = CPOP::cpop_model(
  z1 = list_lratio_binary$ns,
  z2 = list_lratio_binary$array,
  y1 = list_binary_lassoy$ns,
  y2 = list_binary_lassoy$array,
  family = "binomial",
  w = ns_array_w, 
  alpha = 0.1,
  n_features = 20)

single_cpop

CPOP::plot_ratio_network(single_cpop$feature)
```

## Prediction
```{r}
CPOP::predict_cpop(cpop_result = single_cpop,
                   newz = list_lratio_binary$tcga,
                   s = "lambda.min",
                   model_number = "avg", tibble = TRUE) %>% 
  left_join(list_binary_lassoy_df, by = c("samples" = "sample_id")) %>% 
  ggplot(aes(x = classification, y = CPOP::expit(cpop_model_avg))) +
  geom_boxplot() +
  geom_hline(yintercept = 0.5, col = "red") +
  geom_jitter(width = 0.2)
```



# Bootstrap samples
```{r, message=FALSE, eval = FALSE}
set.seed(123)
nexp = 100

ns_index = replicate(nexp, sample(1:nrow(list_lratio_binary$ns), size = 100, replace = TRUE), simplify = FALSE)
array_index = replicate(nexp, sample(1:nrow(list_lratio_binary$array), size = 100, replace = TRUE), simplify = FALSE)

resample_lratio_ns = purrr::map(.x = ns_index, .f = ~ list_lratio_binary$ns[.x,])
resample_lratio_array = purrr::map(.x = array_index, .f = ~ list_lratio_binary$array[.x,])
resample_lassoy_ns = purrr::map(.x = ns_index, .f = ~ list_binary_lassoy$ns[.x])
resample_lassoy_array = purrr::map(.x = array_index, .f = ~ list_binary_lassoy$array[.x])
resample_w = purrr::map2(.x = resample_lratio_ns, 
                         .y = resample_lratio_array,
                         .f = CPOP::compute_weights)


# boot_MIA_cpop = mapply(
boot_MIA_cpop = parallel::mcmapply(
  FUN = CPOP::cpop_model,
  z1 = resample_lratio_ns,
  y1 = resample_lassoy_ns, 
  z2 = resample_lratio_array, 
  y2 = resample_lassoy_array, 
  w = resample_w,
  family = "binomial",
  alpha = 0.1,
  n_features = 50, 
  nfolds = 5,
  SIMPLIFY = FALSE,
  mc.cores = 5)

boot_MIA_ns = parallel::mcmapply(
  FUN = cv.glmnet,
  x = resample_lratio_ns,
  y = resample_lassoy_ns, 
  family = "binomial",
  alpha = 1,
  nfolds = 5,
  SIMPLIFY = FALSE,
  mc.cores = 5)

boot_MIA_array = parallel::mcmapply(
  FUN = cv.glmnet,
  x = resample_lratio_array,
  y = resample_lassoy_array, 
  family = "binomial",
  alpha = 1,
  nfolds = 5,
  SIMPLIFY = FALSE,
  mc.cores = 5)


save(boot_MIA_cpop,
     boot_MIA_ns,
     boot_MIA_array,
     file = paste0("data/processed_data/boot_MIA_cpop_", today, ".RData"))
```



# Coefficient visualisation 


## Top features selected

```{r}
load("data/processed_data/boot_MIA_cpop_2020_Feb_16.RData")

nexp = 100
boot_num = sprintf("boot%03d", 1:nexp)
list_features = purrr::map(boot_MIA_cpop, "feature")

features_tbl = list_features %>% 
  magrittr::set_names(boot_num) %>% 
  purrr::map_dfr(~tibble(feature = .x),
                 .id = "boot_num")

(features_tbl_summ = features_tbl %>% 
    group_by(feature) %>% 
    tally() %>% 
    arrange(desc(n)))


CPOP::plot_ratio_network(x = head(features_tbl_summ$feature, 20))
```


## Feature coefficients boxplots

```{r}
ns_coef = boot_MIA_cpop %>% purrr::map("glmnet1") %>% 
  purrr::map(CPOP::get_lasso_coef, tibble = TRUE) %>% 
  magrittr::set_names(boot_num) %>% 
  bind_rows(.id = "boot_num") 

array_coef = boot_MIA_cpop %>% purrr::map("glmnet2") %>% 
  purrr::map(CPOP::get_lasso_coef, tibble = TRUE) %>% 
  magrittr::set_names(boot_num) %>% 
  bind_rows(.id = "boot_num")

mia_coef = bind_rows(
  ns_coef %>% dplyr::mutate(data_name = "ns"),
  array_coef %>% dplyr::mutate(data_name = "array")
)

final_feature = head(features_tbl_summ$feature, 20)

mia_coef %>% 
  dplyr::filter(feature_name %in% final_feature) %>% 
  dplyr::mutate(feature_name = fct_reorder(feature_name, beta)) %>% 
  ggplot(aes(x = feature_name, y = beta, 
             colour = data_name)) +
  geom_boxplot() +
  geom_hline(yintercept = 0, colour = "black") +
  theme(axis.text.x = element_blank())
```


```{r}
mia_coef %>%
  group_by(feature_name) %>% 
  nest() %>% 
  dplyr::mutate(num_select = purrr::map_int(data, nrow)) %>% 
  unnest(data) %>% 
  dplyr::filter(num_select >= 20) %>% 
  group_by(feature_name, data_name) %>% 
  summarise(mean_beta = mean(beta), 
            sd_beta = sd(beta),
            median_beta = median(beta),
            iqr_beta = quantile(beta, 0.75) - quantile(beta, 0.25),
            num_select = unique(num_select)) %>% 
  ggplot(aes(x = median_beta,
             y = iqr_beta, 
             label = num_select)) +
  geom_text()
```


# Prediction on TCGA binary samples

## Sample prediction values boxplot

```{r, fig.height = 6, fig.width = 18}
boot_MIA_cpop_nonull = boot_MIA_cpop[purrr::map_lgl(list_features, ~ !is.null(.x))]

mia_pred_tcga = purrr::map_dfr(
  .x = boot_MIA_cpop_nonull,
  .f = ~ CPOP::predict_cpop(
    cpop_result = .x, 
    newz = list_lratio_binary$tcga,
    s = "lambda.min",
    model_number = "avg", tibble = TRUE),
  .id = "boot_num") %>% 
  left_join(list_binary_lassoy_df, by = c("samples" = "sample_id"))

glimpse(mia_pred_tcga)

mia_pred_tcga_long = mia_pred_tcga %>% 
  dplyr::mutate(samples = fct_reorder(samples, cpop_model_avg)) %>% 
  tidyr::pivot_longer(
    cols = c("cpop_model1", "cpop_model2", "cpop_model_avg"),
    names_to = "cpop_model_num",
    values_to = "cpop_pred_values") %>% 
  dplyr::mutate(cpop_pred_class = ifelse(cpop_pred_values > 0, "Poor", "Good") %>% as.factor)

glimpse(mia_pred_tcga_long)

mia_pred_tcga_long %>%
  dplyr::mutate(cpop_pred_values = cpop_pred_values %>% CPOP::expit()) %>% 
  ggplot(aes(x = samples, y = cpop_pred_values,
             fill = classification)) +
  geom_boxplot() +
  geom_hline(yintercept = 0.5) +
  facet_wrap(~cpop_model_num, scales = "free") +
  theme(axis.text.x = element_blank())
```


## Sample binary prediction metrics

```{r}
purrr::map_dfr(
  .x = list(precision, recall, f_meas, bal_accuracy, mcc),
  .f = ~ mia_pred_tcga_long %>% 
    group_by(boot_num, cpop_model_num) %>% 
    .x(truth = classification, estimate = cpop_pred_class)) %>% 
  ggplot(aes(x = cpop_model_num,
             y = .estimate)) +
  geom_boxplot() +
  geom_beeswarm() +
  facet_wrap(~ .metric, scales = "free_y")
```


# Prediction on TCGA survial samples

```{r}
mia_pred_tcga_survival = purrr::map_dfr(
  .x = boot_MIA_cpop_nonull,
  .f = ~ CPOP::predict_cpop(
    cpop_result = .x, 
    newz = list_lratio_data_survival$tcga,
    s = "lambda.min",
    model_number = "avg", tibble = TRUE),
  .id = "boot_num") %>% 
  left_join(tcga_sample_data, by = c("samples" = "sample_id"))

glimpse(mia_pred_tcga_survival)

mia_pred_tcga_survival_long = mia_pred_tcga_survival %>% 
  dplyr::mutate(samples = fct_reorder(samples, cpop_model_avg)) %>% 
  tidyr::pivot_longer(
    cols = c("cpop_model1", "cpop_model2", "cpop_model_avg"),
    names_to = "cpop_pred_names",
    values_to = "cpop_pred_values") %>% 
  dplyr::mutate(cpop_pred_class = ifelse(cpop_pred_values > 0, "Poor", "Good") %>% as.factor)

glimpse(mia_pred_tcga_survival_long)

mia_pred_tcga_survival_survfit = mia_pred_tcga_survival_long %>% 
  group_by(boot_num, naive_tumor_stage, cpop_pred_names) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(
    surv = purrr::map(
      .x = data,
      .f = function(d){survfit(Surv(time, status) ~ cpop_pred_class, data = data.frame(d))}),
    survdiff = purrr::map(
      .x = data,
      .f = function(d){tryCatch(survdiff(Surv(time, status) ~ cpop_pred_class, data = data.frame(d)), error = function(e)return(NA))}),
    # samples = purrr::map(
    #   survdiff,
    #   function(d){tryCatch(as_tibble(d$n), error = function(e)return(as_tibble(NA)))}) %>% purrr::map(as_tibble),
    perc_good = purrr::map_dbl(
      data, .f = function(d){sum(d$cpop_pred_class == "Good")/length(d$cpop_pred_class)}),
    chisq = purrr::map_dbl(survdiff, function(d){tryCatch(d$chisq, error = function(e)return(NA))})
    # ggsurv = purrr::map2(
    #   .x = surv, .y = data,
    #   .f = function(s, data){ggsurvplot(fit = s, data = data,
    #                                     pval = TRUE)})
  )


mia_pred_tcga_survival_survfit %>% 
  select(chisq) %>% 
  ungroup() %>% 
  ggplot(aes(x = cpop_pred_names, 
             y = chisq,
             colour = cpop_pred_names)) +
  geom_boxplot() +
  geom_beeswarm() +
  ggsci::scale_colour_d3() +
  geom_hline(yintercept = qchisq(0.95, 1)) +
  facet_wrap(~naive_tumor_stage, scale = "free") +
  theme(axis.text.x = element_blank())
```

# Visualise Lasso coefficients

```{r}
lasso_ns_features = boot_MIA_ns %>% 
  purrr::map(.f = ~ tibble(feature = rownames(coef(.x)),
                           beta = coef(.x)[,1])) %>% 
  magrittr::set_names(boot_num) %>% 
  bind_rows(.id = "boot_num") %>% 
  dplyr::mutate(type = "MIA-2018 (NanoString)")

lasso_array_features = boot_MIA_array %>% 
  purrr::map(.f = ~ tibble(feature = rownames(coef(.x)),
                           beta = coef(.x)[,1])) %>% 
  magrittr::set_names(boot_num) %>% 
  bind_rows(.id = "boot_num") %>% 
  dplyr::mutate(type = "MIA-2015 (Microarray)")

lasso_features = bind_rows(
  lasso_ns_features,
  lasso_array_features)

lasso_top_features = lasso_features %>%
  group_by(feature) %>% 
  summarise(num_select = sum(beta != 0)) %>% 
  arrange(-num_select) %>% 
  slice(2:20) %>% 
  pull(feature)

lasso_features %>% 
  dplyr::filter(feature %in% lasso_top_features) %>% 
  ggplot(aes(x = feature, y = beta, colour = type)) +
  geom_boxplot()

lasso_features_plot = lasso_features %>%
  group_by(type, feature) %>% 
  dplyr::filter(feature %in% lasso_top_features) %>% 
  summarise(num_select = sum(beta != 0)) %>% 
  dplyr::mutate(feature = fct_reorder(feature, num_select)) %>% 
  ggplot(aes(x = feature, y = num_select, 
             fill = type)) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = "Set1") +
  theme(axis.text.x = element_blank())

ggsave(lasso_features_plot,
       filename = paste0("figures/lasso_features_plot_", file_version, ".pdf"),
       height = 4, width = 8)
```


# Session info 
```{r}
sessioninfo::session_info()
```

